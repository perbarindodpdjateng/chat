<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Operator Dashboard - Live Chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }

        .dashboard {
            display: flex;
            height: 100vh;
        }

        .users-panel {
            width: 300px;
            background: white;
            border-right: 1px solid #e0e0e0;
            overflow-y: auto;
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .user-item {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.3s;
        }

        .user-item:hover {
            background: #f8f9fa;
        }

        .user-item.active {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
        }

        .user-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .last-message {
            font-size: 12px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-header {
            background: white;
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #fafafa;
        }

        .chat-input {
            background: white;
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }

        .message-bubble {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 15px;
            font-size: 14px;
        }

        .message.user .message-bubble {
            background: #e3f2fd;
            align-self: flex-end;
        }

        .message.operator .message-bubble {
            background: #f5f5f5;
            align-self: flex-start;
        }

        .operator-panel {
            background: white;
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-online {
            background: #e8f5e8;
            color: #4CAF50;
        }

        .status-offline {
            background: #ffebee;
            color: #f44336;
        }

        .input-field {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
        }

        .send-btn {
            padding: 10px 20px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="users-panel">
            <div class="operator-panel">
                <h3>Operator Dashboard</h3>
                <span class="status-badge status-online">Online</span>
            </div>
            <div id="usersList">
                <!-- User list akan diisi oleh JavaScript -->
            </div>
        </div>
        
        <div class="chat-area">
            <div class="chat-header">
                <h3 id="currentUser">Pilih user untuk memulai chat</h3>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <div style="text-align: center; color: #999; margin-top: 50px;">
                    Pilih user dari panel kiri untuk memulai percakapan
                </div>
            </div>
            
            <div class="chat-input" id="chatInput" style="display: none;">
                <input 
                    type="text" 
                    class="input-field" 
                    id="messageInput" 
                    placeholder="Ketik pesan..."
                >
                <button class="send-btn" id="sendBtn">Kirim</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        class OperatorDashboard {
            constructor() {
                this.socket = io('http://localhost:3001');
                this.currentUserId = null;
                this.messages = new Map();
                
                this.setupSocketListeners();
                this.registerOperator();
            }

            registerOperator() {
                this.socket.emit('register_operator', {
                    operatorId: 'operator_1',
                    name: 'Customer Service'
                });
            }

            setupSocketListeners() {
                this.socket.on('new_user', (data) => {
                    this.addUserToList(data.userId);
                });

                this.socket.on('new_message', (data) => {
                    this.handleNewMessage(data);
                });

                this.socket.on('user_disconnected', (data) => {
                    this.removeUserFromList(data.userId);
                });
            }

            addUserToList(userId) {
                const usersList = document.getElementById('usersList');
                const userDiv = document.createElement('div');
                userDiv.className = 'user-item';
                userDiv.id = `user-${userId}`;
                userDiv.onclick = () => this.selectUser(userId);
                
                userDiv.innerHTML = `
                    <div class="user-name">User ${userId}</div>
                    <div class="last-message">User baru terhubung</div>
                `;
                
                usersList.appendChild(userDiv);
            }

            removeUserFromList(userId) {
                const userElement = document.getElementById(`user-${userId}`);
                if (userElement) {
                    userElement.remove();
                }
                
                if (this.currentUserId === userId) {
                    this.currentUserId = null;
                    this.updateChatArea();
                }
            }

            selectUser(userId) {
                // Update active state
                document.querySelectorAll('.user-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                const userElement = document.getElementById(`user-${userId}`);
                if (userElement) {
                    userElement.classList.add('active');
                }
                
                this.currentUserId = userId;
                this.updateChatArea();
                this.loadMessages(userId);
            }

            updateChatArea() {
                const currentUserElement = document.getElementById('currentUser');
                const chatInput = document.getElementById('chatInput');
                const chatMessages = document.getElementById('chatMessages');
                
                if (this.currentUserId) {
                    currentUserElement.textContent = `Chat dengan User ${this.currentUserId}`;
                    chatInput.style.display = 'flex';
                } else {
                    currentUserElement.textContent = 'Pilih user untuk memulai chat';
                    chatInput.style.display = 'none';
                    chatMessages.innerHTML = `
                        <div style="text-align: center; color: #999; margin-top: 50px;">
                            Pilih user dari panel kiri untuk memulai percakapan
                        </div>
                    `;
                }
            }

            loadMessages(userId) {
                const messages = this.messages.get(userId) || [];
                const chatMessages = document.getElementById('chatMessages');
                
                if (messages.length === 0) {
                    chatMessages.innerHTML = `
                        <div style="text-align: center; color: #999; margin-top: 50px;">
                            Mulai percakapan dengan user ini
                        </div>
                    `;
                } else {
                    chatMessages.innerHTML = messages.map(msg => `
                        <div class="message ${msg.sender}">
                            <div class="message-bubble">${msg.message}</div>
                        </div>
                    `).join('');
                }
            }

            handleNewMessage(data) {
                const { message, userId } = data;
                
                if (!this.messages.has(userId)) {
                    this.messages.set(userId, []);
                }
                
                this.messages.get(userId).push({
                    message: message,
                    sender: 'user',
                    timestamp: new Date()
                });
                
                // Update last message in user list
                const userElement = document.getElementById(`user-${userId}`);
                if (userElement) {
                    const lastMessageElement = userElement.querySelector('.last-message');
                    if (lastMessageElement) {
                        lastMessageElement.textContent = message;
                    }
                }
                
                // If this user is currently selected, update chat area
                if (this.currentUserId === userId) {
                    this.loadMessages(userId);
                }
            }

            sendMessage() {
                const input = document.getElementById('messageInput');
                const message = input.value.trim();
                
                if (!message || !this.currentUserId) return;
                
                // Add to local messages
                if (!this.messages.has(this.currentUserId)) {
                    this.messages.set(this.currentUserId, []);
                }
                
                this.messages.get(this.currentUserId).push({
                    message: message,
                    sender: 'operator',
                    timestamp: new Date()
                });
                
                // Send to server
                this.socket.emit('send_message', {
                    userId: this.currentUserId,
                    message: message
                });
                
                // Update UI
                this.loadMessages(this.currentUserId);
                input.value = '';
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            const dashboard = new OperatorDashboard();
            
            document.getElementById('sendBtn').addEventListener('click', () => {
                dashboard.sendMessage();
            });
            
            document.getElementById('messageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    dashboard.sendMessage();
                }
            });
        });
    </script>
</body>
</html>
